<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Position & Margin Calc</title>
    <style>
        :root { 
            --bg: #121212; 
            --card: #1e2026; 
            --input: #2b2f36; 
            --text: #eaecef; 
            --label: #848e9c;
            --green: #0ecb81; 
            --red: #f6465d; 
            --primary: #fcd535; 
            --yellow: #f0b90b;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        
        .container { background-color: var(--card); width: 100%; max-width: 400px; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        
        h2 { text-align: center; margin: 0 0 20px 0; font-size: 1.2rem; color: var(--text); }
        
        /* Input Styling to match Exchange */
        .row { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
        .col { flex: 1; }
        
        label { display: block; color: var(--label); font-size: 0.75rem; margin-bottom: 4px; }
        
        .input-wrapper { position: relative; }
        input { width: 100%; background: var(--input); border: 1px solid transparent; color: var(--text); padding: 10px; border-radius: 4px; font-size: 0.95rem; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        input:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .suffix { position: absolute; right: 10px; top: 10px; color: var(--label); font-size: 0.8rem; pointer-events: none; }

        /* Toggles */
        .tabs { display: flex; background: var(--input); border-radius: 4px; padding: 2px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 8px; font-size: 0.85rem; cursor: pointer; border-radius: 2px; color: var(--label); transition: 0.2s; font-weight: 600; }
        
        /* Dynamic Colors for Long/Short */
        .tab.active-long { background: var(--green); color: #fff; }
        .tab.active-short { background: var(--red); color: #fff; }
        .tab.active-fee { background: #474d57; color: var(--text); }

        /* Action Button */
        button.calc { width: 100%; padding: 14px; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; background-color: var(--primary); color: #000; }
        button.calc:hover { opacity: 0.9; }

        /* Results Section */
        .result-box { margin-top: 20px; border-top: 1px solid #2b2f36; padding-top: 15px; display: none; }
        
        .res-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .res-val { font-weight: bold; color: var(--text); }
        
        .final-qty-box { background: #2b2f36; padding: 15px; border-radius: 6px; text-align: center; margin-top: 15px; border: 1px solid #474d57; }
        .final-qty-label { color: var(--label); font-size: 0.8rem; margin-bottom: 5px; }
        .final-qty-val { font-size: 1.6rem; font-weight: bold; color: var(--primary); }
        
        /* Alerts */
        .alert { font-size: 0.8rem; text-align: center; margin-top: 10px; color: var(--red); display: none; }
        .warn { color: var(--yellow); }

    </style>
</head>
<body>

<div class="container">
    <h2>Position Size Calculator</h2>

    <!-- Long / Short Tabs -->
    <div class="tabs">
        <div class="tab active-long" id="btn-long" onclick="setSide('long')">Long</div>
        <div class="tab" id="btn-short" onclick="setSide('short')">Short</div>
    </div>

    <!-- Inputs Row 1 -->
    <div class="row">
        <div class="col">
            <label>Available Balance</label>
            <div class="input-wrapper">
                <input type="number" id="balance" placeholder="56.67" step="any">
                <span class="suffix">USDT</span>
            </div>
        </div>
        <div class="col">
            <label>Leverage</label>
            <div class="input-wrapper">
                <input type="number" id="leverage" placeholder="50" value="50">
                <span class="suffix">x</span>
            </div>
        </div>
    </div>

    <!-- Inputs Row 2 -->
    <div class="row">
        <div class="col">
            <label>Entry Price</label>
            <div class="input-wrapper">
                <input type="number" id="entry" placeholder="3034.83">
            </div>
        </div>
        <div class="col">
            <label>Stop Loss</label>
            <div class="input-wrapper">
                <input type="number" id="stop" placeholder="Price">
            </div>
        </div>
    </div>

    <!-- Risk Input -->
    <div class="row">
        <div class="col">
            <label>Risk Amount (How much to lose?)</label>
            <div class="input-wrapper">
                <input type="number" id="risk" placeholder="10, 50, 100...">
                <span class="suffix">$</span>
            </div>
        </div>
    </div>
    
    <!-- Fee Toggle -->
    <div style="margin-top:10px; margin-bottom: 5px;">
        <label>Entry Order Type (Fees)</label>
    </div>
    <div class="tabs" style="margin-bottom: 5px;">
        <div class="tab active-fee" id="btn-maker" onclick="setFee('maker')">Limit (Maker 0.01%)</div>
        <div class="tab" id="btn-taker" onclick="setFee('taker')">Market (Taker 0.04%)</div>
    </div>

    <button class="calc" onclick="calculate()">Calculate</button>

    <!-- Results -->
    <div class="result-box" id="result-box">
        
        <!-- The Main Result -->
        <div class="final-qty-box" id="qty-box">
            <div class="final-qty-label">QUANTITY TO ENTER</div>
            <div class="final-qty-val" id="res-qty">0.000 ETH</div>
        </div>
        
        <div class="alert" id="balance-alert">⚠️ Insufficient Balance for this risk!</div>

        <div style="margin-top: 15px;">
            <div class="res-row">
                <span>Margin Cost:</span>
                <span class="res-val" id="res-margin">0.00 USDT</span>
            </div>
            <div class="res-row">
                <span>Total Fees (Est):</span>
                <span class="res-val" id="res-fees" style="color:var(--red)">0.00 USDT</span>
            </div>
            <div class="res-row">
                <span>Real Loss (Price+Fee):</span>
                <span class="res-val" id="res-loss">0.00 USDT</span>
            </div>
            <div class="res-row">
                <span>Max Wallet Buy:</span>
                <span class="res-val" id="res-max-wallet">0.000 ETH</span>
            </div>
        </div>
    </div>
</div>

<script>
    let side = 'long';
    let isMaker = true;

    // Fees Config
    const MAKER_FEE = 0.0001; // 0.01%
    const TAKER_FEE = 0.0004; // 0.04%

    function setSide(s) {
        side = s;
        document.getElementById('btn-long').className = s === 'long' ? 'tab active-long' : 'tab';
        document.getElementById('btn-short').className = s === 'short' ? 'tab active-short' : 'tab';
    }

    function setFee(type) {
        isMaker = (type === 'maker');
        document.getElementById('btn-maker').className = isMaker ? 'tab active-fee' : 'tab';
        document.getElementById('btn-taker').className = !isMaker ? 'tab active-fee' : 'tab';
    }

    function calculate() {
        // 1. Get Values
        const balance = parseFloat(document.getElementById('balance').value);
        const leverage = parseFloat(document.getElementById('leverage').value);
        const entry = parseFloat(document.getElementById('entry').value);
        const stop = parseFloat(document.getElementById('stop').value);
        const risk = parseFloat(document.getElementById('risk').value);

        const alertBox = document.getElementById('balance-alert');
        const qtyBox = document.getElementById('qty-box');
        
        alertBox.style.display = 'none';
        qtyBox.style.border = '1px solid #474d57';

        if(isNaN(entry) || isNaN(stop) || isNaN(risk) || isNaN(balance)) {
            alert("Please fill in all fields");
            return;
        }

        // 2. Validate Direction
        if(side === 'long' && stop >= entry) { alert("Long: Stop must be lower than Entry"); return; }
        if(side === 'short' && stop <= entry) { alert("Short: Stop must be higher than Entry"); return; }

        // 3. Math: Calculate Risk-Based Quantity
        const entryFeeRate = isMaker ? MAKER_FEE : TAKER_FEE;
        const exitFeeRate = TAKER_FEE; // SL is always market

        const priceDiff = Math.abs(entry - stop);
        const feesPerUnit = (entry * entryFeeRate) + (stop * exitFeeRate);
        const lossPerUnit = priceDiff + feesPerUnit;

        // "How many coins should I buy to lose exactly my risk amount?"
        let safeQty = risk / lossPerUnit;

        // 4. Math: Calculate Wallet Max Cap (The limit shown in your screenshot)
        // Max Position Value = Balance * Leverage
        // Max Qty = (Balance * Leverage) / Entry
        // We reduce balance slightly (98%) to account for opening fees not being part of margin
        const maxWalletQty = (balance * 0.98 * leverage) / entry;

        // 5. Logic: Can we afford it?
        let finalQty = safeQty;
        let isInsufficient = false;

        if (safeQty > maxWalletQty) {
            isInsufficient = true;
            // Highlight the issue
            alertBox.style.display = 'block';
            alertBox.innerHTML = `⚠️ Insufficient Balance!<br>To risk $${risk}, you need to buy ${safeQty.toFixed(3)} coins.<br>Your wallet max is ${maxWalletQty.toFixed(3)}.`;
            qtyBox.style.border = '1px solid var(--red)';
        }

        // 6. Calculate details based on the Safe Risk Quantity
        const positionSize = finalQty * entry;
        const marginRequired = positionSize / leverage;
        const totalFees = finalQty * feesPerUnit; // approximate total fees
        const realLoss = risk; // Should match exactly

        // 7. Render
        document.getElementById('result-box').style.display = 'block';
        
        // This is the number you type into the screenshot box
        document.getElementById('res-qty').innerText = finalQty.toFixed(4) + (side==='long'?"":"");
        document.getElementById('res-qty').style.color = isInsufficient ? 'var(--red)' : 'var(--primary)';

        document.getElementById('res-margin').innerText = marginRequired.toFixed(2) + " USDT";
        document.getElementById('res-fees').innerText = totalFees.toFixed(2) + " USDT";
        document.getElementById('res-loss').innerText = realLoss.toFixed(2) + " USDT";
        document.getElementById('res-max-wallet').innerText = maxWalletQty.toFixed(4);
    }
</script>

</body>
</html>
